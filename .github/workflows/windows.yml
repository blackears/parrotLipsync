name: ðŸªŸ Windows Builds
on: [ workflow_call, workflow_dispatch ]

jobs:
  build:
    name: ðŸªŸ Windows ${{ matrix.arch }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runs_on: windows-latest
            py_arch: x64
            blender_arch: x64
            blender_platform: windows-x64
          - arch: arm64
            runs_on: windows-11-arm
            py_arch: arm64
            blender_arch: arm64
            blender_platform: windows-amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: ${{ matrix.py_arch }}  # x64 or arm64

      - name: Download Wheels
        run: |
          mkdir source/wheels
          # Optional, fail fast if no native wheel exists for this arch
          pip wheel --prefer-binary -w source/wheels allosaurus

      - name: Create manifest
        run: |
          cd source
          Copy-Item -Path "..\blender_manifest_template_windows.toml" -Destination "blender_manifest.toml"
          $out = "blender_manifest.toml"
          Add-Content $out "wheels = ["
          Get-ChildItem .\wheels -File | ForEach-Object { "  `"./wheels/$($_.Name)`"," } | Add-Content $out
          Add-Content $out -Value "]"
          Get-Content $out

      - name: Setup Blender
        run: |
          cd ${{ github.workspace }}
          $BLENDER_VERSION="4.5.2"
          $BLENDER_DIR_NAME="blender-${BLENDER_VERSION}-windows-${{ matrix.blender_arch }}"
          $BLENDER_ARCHIVE="$BLENDER_DIR_NAME.zip"
          $BLENDER_URL="https://download.blender.org/release/Blender4.5/$BLENDER_ARCHIVE"
          Invoke-WebRequest $BLENDER_URL -OutFile $BLENDER_ARCHIVE
          Expand-Archive -Path $BLENDER_ARCHIVE -DestinationPath .
          Rename-Item -Path $BLENDER_DIR_NAME -NewName blender

      - name: Build Extension
        run: |
          cd ${{ github.workspace }}
          mkdir extension
          .\blender\blender.exe --command extension build --source-dir source --output-dir extension
          dir extension

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          include-hidden-files: true
          name: parrotLipsync-windows-${{ matrix.arch }}
          path: |
            ${{ github.workspace }}/extension/

