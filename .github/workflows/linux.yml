name: 🐧 Linux Builds
on: [ workflow_call, workflow_dispatch ]

jobs:
  build:
    name: 🐧 Linux ${{ matrix.arch }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runs_on: ubuntu-latest
            py_arch: x64
            blender_arch: x64
            blender_platform: linux-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: ${{ matrix.py_arch }}  # x64 or arm64

      - name: Download Wheels
        run: |
          mkdir source/wheels
          # Optional, fail fast if no native wheel exists for this arch
          pip wheel --prefer-binary -w source/wheels allosaurus

      - name: Create manifest
        run: |
          cd source
          (cat ../blender_manifest_template_linux.toml; echo "wheels = ["; ls -1 wheels | sed 's/\(^.*$\)/  "\.\/wheels\/\1",/'; echo "]") > blender_manifest.toml

      - name: Setup Blender
        run: |
          cd ${{ github.workspace }}
          BLENDER_VERSION="4.5.2"
          BLENDER_ARCHIVE="blender-${BLENDER_VERSION}-linux-${{ matrix.arch }}.zip"
          BLENDER_URL="https://download.blender.org/release/Blender4.5/${BLENDER_ARCHIVE}"
          curl -L ${BLENDER_URL} -o ${BLENDER_ARCHIVE}
          unzip ${BLENDER_ARCHIVE}
          mv blender-${BLENDER_VERSION}-linux-${{ matrix.arch }} blender 
          echo "--pwd--"
          pwd
          echo "--root dir ls--"
          ls
          echo "--blender dir ls--"
          ls blender

      - name: Build Extension
        run: |
          cd ${{ github.workspace }}
          mkdir extension
          .\blender\blender.exe --command extension build --source-dir source --output-dir extension
          echo "--blender extension ls--"
          ls extension

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          include-hidden-files: true
          name: parrotLipsync-linux-${{ matrix.arch }}
          path: |
            ${{ github.workspace }}/extension/


