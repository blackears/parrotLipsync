name: ðŸªŸ Windows Builds
on: [ workflow_call, workflow_dispatch ]

jobs:
  build:
    name: ðŸªŸ Windows ${{ matrix.arch }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runs_on: windows-2025
            py_arch: x64
            plugin_version: "1.1.3"
            blender_version: "5.0.0"
            blender_arch: x64
            blender_platform: windows-x64
          # - arch: arm64
          #   runs_on: windows-11-arm
          #   py_arch: arm64
          #   blender_arch: arm64
          #   blender_platform: windows-amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: ${{ matrix.py_arch }}  # x64 or arm64

      - name: Download Wheels
        run: |
          mkdir source/wheels
          # Optional, fail fast if no native wheel exists for this arch
          #pip wheel --prefer-binary -w source/wheels allosaurus
          pip wheel -w source/wheels allosaurus

      - name: Create manifest
        run: |
          cd source
          Copy-Item -Path "..\blender_manifest_template_windows.toml" -Destination "blender_manifest.toml"
          $out = "blender_manifest.toml"
          Add-Content $out "wheels = ["
          Get-ChildItem .\wheels -File | ForEach-Object { "  `"./wheels/$($_.Name)`"," } | Add-Content $out
          Add-Content $out -Value "]"
          Get-Content $out

      - name: Setup Blender
        run: |
          cd ${{ github.workspace }}
          $BLENDER_DIR_NAME="blender-${{ matrix.blender_version }}-windows-${{ matrix.blender_arch }}"
          $BLENDER_ARCHIVE="$BLENDER_DIR_NAME.zip"
          $BLENDER_URL="https://download.blender.org/release/Blender5.0/$BLENDER_ARCHIVE"
          Invoke-WebRequest $BLENDER_URL -OutFile $BLENDER_ARCHIVE
          Expand-Archive -Path $BLENDER_ARCHIVE -DestinationPath .
          Rename-Item -Path $BLENDER_DIR_NAME -NewName blender

      - name: Build Extension
        run: |
          cd ${{ github.workspace }}
          mkdir extension
          .\blender\blender.exe --command extension build --source-dir source --output-filepath "extension/parrotLipsync-${{ matrix.blender_version }}-windows-${{ matrix.arch }}.zip"
          dir extension

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: parrotLipsync-${{ matrix.plugin_version }}-windows-${{ matrix.arch }}
          path: "extension/parrotLipsync-${{ matrix.plugin_version }}-windows-${{ matrix.arch }}.zip"
          compression-level: 0

