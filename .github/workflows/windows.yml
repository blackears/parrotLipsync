name: ðŸªŸ Windows Builds
on: [ workflow_call, workflow_dispatch ]

jobs:
  build:
    name: ðŸªŸ Windows ${{ matrix.arch }}
    runs-on: [windows-latest]
    strategy:
      fail-fast: false
      matrix:
        platform: [windows]
        arch: [x64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
      #- run: pip install allosaurus

      - name: Download Wheels
        run: |
          mkdir source/wheels
          pip wheel -w source/wheels allosaurus

      - name: Create manifest
        run: |
          cd source
          echo "--wheels--"
          Copy-Item -Path "blender_manifest_base.toml" -Destination "blender_manifest.toml"
          $outputFile = "blender_manifest.toml"
          Add-Content -Path $outputFile -Value "wheels = ["
          Get-ChildItem -Path ".\wheels" -File | ForEach-Object { "  `"$($_.Name)`"," } | Add-Content -Path $outputFile
          Add-Content -Path $outputFile -Value "]"
          Get-Content $outputFile
#          Write-Host "wheels = ["
#          Get-ChildItem -Path "C:\Your\Directory\Path" -File | ForEach-Object { "`"$($_.Name)`"" }
#          Write-Host "]"
#          for /f "delims=" %A in ('dir /b') do @echo   "%A",
#          (cat blender_manifest_base.toml; echo "wheels = ["; ls -1 wheels | sed 's/\(^.*$\)/  "\.\/wheels\/\1",/'; echo "]") > blender_manifest.toml
#          cat blender_manifest.toml
#          ls source/wheels

      - name: Setup Blender
        run: |
          cd ${{ github.workspace }}
          $BLENDER_VERSION="4.5.1"
          $BLENDER_ARCHIVE="blender-${BLENDER_VERSION}-windows-${{ matrix.arch }}.zip"
          $BLENDER_URL="https://download.blender.org/release/Blender4.5/${BLENDER_ARCHIVE}"
          Invoke-WebRequest $BLENDER_URL -OutFile $BLENDER_ARCHIVE
          Expand-Archive -Path $BLENDER_ARCHIVE 
          Rename-Item -Path blender-$BLENDER_VERSION-windows-${{ matrix.arch }} -NewName "blender"
          echo "--pwd--"
          pwd
          echo "--root dir ls--"
          Get-ChildItem -Path "."
          echo "--blender dir ls--"
          Get-ChildItem -Path ".\blender"

      - name: Build Extension
        run: |
          cd ${{ github.workspace }}
          mkdir extension
          .\blender\blender.exe --command extension build --source-dir source --output-dir extension
          ls extension

